@using Microsoft.AspNet.Identity;
@using System;
@using System.Globalization;
@model IEnumerable<Priority_Q.Models.Restaurant>

@{
    ViewBag.Title = "All Restaurants";
    var AllTableCounts = ViewData["AllTableCounts"] as List<int>;
    var AllCustomerCounts = ViewData["AllCustomerCounts"] as List<int>;
}

<h2>
    @ViewBag.Title
    &nbsp;
    @if (Request.IsAuthenticated)
    {
        //this is to prevent a random person from generating new restaurants
        <a class="btn btn-info" href='@string.Format("/Restaurants/Create")' title="Add a New Restaurant">
            <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
        </a>
    }
</h2>


@using (Html.BeginForm())
{
    <p>
        Find by name or location: @Html.TextBox("SearchString")
        <input type="submit" value="Search" />
    </p>
}

<table class="table table-striped table-hover ">
    @{
        var counter = 0;
    }

    @foreach (var item in Model)
    {
        <tr>
            <td>
            </td>
            <td>
                @if (Request.IsAuthenticated)
                {
                    <a class="btn btn-info" href='@string.Format("/Restaurants/ViewTables/{0}", item.ID)'>
                        @Html.DisplayFor(modelItem => item.Name)
                    </a>
                }
                else
                {
                    <a class="btn btn-info" href='@string.Format("/Restaurants/CustomerView/{0}", item.ID)'>
                        @Html.DisplayFor(modelItem => item.Name)
                    </a>
                }
            </td>
            <td>
                @{
                    bool isOpen = false;
                }
                @if (ViewBag.CurrentHour >= item.OpeningHourStart) 
                {
                    /*Two cases:
                    if the opening and closing hour are both on the same day (10am - 10pm, which is 10:00 - 22:00)
                        OR 
                    if the closing hour is on the day after (10am - 3am, which is 10:00 - 03:00)
                    */
                    if ((item.OpeningHourStart < item.OpeningHourEnd && ViewBag.CurrentHour < item.OpeningHourEnd) ||
                        (item.OpeningHourStart >= item.OpeningHourEnd && ViewBag.CurrentHour < item.OpeningHourEnd + 24))
                    { 
                        isOpen = true;
                    }
                    else
                    {
                        isOpen = false;
                    }
                }
                else
                {
                    isOpen = false;
                }
                @if (isOpen)
                {
                    <span class="label label-success">Open</span>
                }
                else
                {
                    <span class="label label-danger">Closed</span>
                }
                <span class="glyphicon glyphicon-time"></span>
                <!-- add zero to single digit numbers (3 -> 03), but leave it alone if it's double digit-->
                @DateTime.ParseExact(item.OpeningHourStart.ToString().PadLeft(2, '0'), "HH", CultureInfo.CurrentCulture).ToString("h:mm tt")
                -
                @DateTime.ParseExact(item.OpeningHourEnd.ToString().PadLeft(2, '0'), "HH", CultureInfo.CurrentCulture).ToString("h:mm tt")
                
                <br />
                @if (/*isOpen*/ true)
                { 
                    if (AllTableCounts[counter] > 0)
                    {
                        <span class="label label-success">No Wait</span>
                        <span class="label label-info">@AllTableCounts[counter] Open Table(s)</span> 
                    }
                    else
                    {
                        <span class="label label-danger">Wait in Line</span>
                        <span class="label label-info">@AllCustomerCounts[counter] Group(s) Waiting</span> 
                    }
                }
                <br />
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.StreetAddress) <br />
                @Html.DisplayFor(modelItem => item.City) <br />
                @Html.DisplayFor(modelItem => item.PhoneNumber)
            </td>
            <td>
 
            </td>
            <td>
       
            </td>
            <td>
                @if (Request.IsAuthenticated && item.UserID.Equals(User.Identity.GetUserId()))
                {
                    //only logged in users should be able to edit and delete
                    //best if only the user modifies their own restaurant and not someone else's
                    <a class="btn btn-warning" href='@string.Format("/Restaurants/Edit/{0}", item.ID)' title="Edit">
                        <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
                    </a>
                    <a class="btn btn-danger" href='@string.Format("/Restaurants/Delete/{0}", item.ID)' title="Delete"> 
                        <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>  
                    </a>
                }

            </td>
        </tr>
                counter++;
    }

</table>
