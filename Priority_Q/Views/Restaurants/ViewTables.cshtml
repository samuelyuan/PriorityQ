@using System.Globalization;

@{
    ViewBag.Title = "View Tables";
    var restaurant = ViewData["Restaurant"] as Priority_Q.Models.Restaurant;
    var allTables = ViewData["AllTables"] as IEnumerable<Priority_Q.Models.Table>;
    var allCustomers = ViewData["AllCustomers"] as IEnumerable<Priority_Q.Models.Customer>;
    var mostRecentNews = ViewData["MostRecentNews"] as Priority_Q.Models.NewsInfo;
    var todayReservations = ViewData["TodayReservations"] as List<List<Priority_Q.Models.Reservation>>;
}

@functions {
    private String DisplayTableData(int counter, Priority_Q.Models.Table item)
    {
        return "#" + counter + " --- [Max: " + item.MaxCapacity + "]";
    }

    private Boolean IsOwner()
    {
        return (Request.IsAuthenticated && ViewBag.OwnsRestaurant);
    }

    private String ConvertIntTo24Hour(int number)
    {
        String convertToString = number.ToString().PadLeft(2, '0');
        DateTime convertToDateTime = DateTime.ParseExact(convertToString, "HH", CultureInfo.CurrentCulture);
        return convertToDateTime.ToString("h:mm tt");
    }
}

<h2>@restaurant.Name</h2>

<span class="glyphicon glyphicon-map-marker"></span> @restaurant.StreetAddress , @restaurant.City &emsp; 
<span class="glyphicon glyphicon-time"></span> @ConvertIntTo24Hour(restaurant.OpeningHourStart) - @ConvertIntTo24Hour(restaurant.OpeningHourEnd)
<br />
<span class="glyphicon glyphicon-earphone"></span> @restaurant.PhoneNumber

<p></p>
<div class="panel panel-default">
    <div class="panel-body">
        <!-- Create two columns: Empty and Occupied tables -->
        <div class="col-xs-6">
            <h3>
                Tables Available
                <span class="label label-default">
                    @ViewBag.AvailableTablesCount
                </span>
                &nbsp;
                @if (IsOwner())
                {
                    <a class="btn btn-warning" href='@string.Format("/Restaurants/ManageTables/{0}", restaurant.ID)'>
                        <span class="glyphicon glyphicon-cog"></span>
                    </a>
                }
                <br />
                
                @if (IsOwner())
                {
                    <span>Reservations</span>
                    <a class="label label-info" href='@string.Format("/Restaurants/ReserveTables/{0}", restaurant.ID)'>
                        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                    </a>
                    <a class="label label-warning" href='@string.Format("/Restaurants/ViewReservations/{0}", restaurant.ID)'>
                        <span class="glyphicon glyphicon-cog" aria-hidden="true"></span>
                    </a>
                }
            </h3>

            <!-- The data passed in is a list of tables for a restaurant -->
            <!-- List all empty tables -->
            <table class="table table-striped table-hover ">
                <!-- contents -->
                @{
                    var counter = 1;
                    var numPerRow = (int)Math.Truncate(Math.Sqrt(allTables.Count()));
                }
                <tr>
                    @foreach (var item in allTables)
                    {
                        if (counter % numPerRow == 1)
                        {
                            @:<tr>
                        }

                        <td>
                            <!-- Table info (#, max capacity) -->
                            <span class="label label-default">#@counter</span> <br />
                            @if (!item.IsOccupied)
                            {
                                if (IsOwner())
                                {
                                    <a class="btn btn-success" href='@string.Format("/Tables/ToggleOccupied/{0}", item.ID)'>
                                        [Max: @item.MaxCapacity <span class="glyphicon glyphicon-user"></span>]
                                    </a>
                                }
                                else
                                {
                                    <span class="btn btn-success disabled" href='@string.Format("/Tables/ToggleOccupied/{0}", item.ID)'>
                                        [Max: @item.MaxCapacity <span class="glyphicon glyphicon-user"></span>]
                                    </span>
                                }
                            }
                            else
                            {
                                if (IsOwner())
                                {
                                    <a class="btn btn-danger" href='@string.Format("/Tables/ToggleOccupied/{0}", item.ID)'>
                                        [Max: @item.MaxCapacity <span class="glyphicon glyphicon-user"></span>]
                                    </a>
                                }
                                else
                                {
                                    <span class="btn btn-danger disabled" href='@string.Format("/Tables/ToggleOccupied/{0}", item.ID)'>
                                        [Max: @item.MaxCapacity <span class="glyphicon glyphicon-user"></span>]
                                    </span>
                                }
                            }

                            <br />

                            <!-- Reservation Data-->
                            <!-- don't display empty blocks -->
                            @if (IsOwner())
                            {
                                if (todayReservations[counter - 1].Count() > 0)
                                {
                                    <span class="btn btn-default">
                                        @foreach (var reservation in todayReservations[counter - 1])
                                        {
                                            <a class="label label-warning" href='@string.Format("/Reservations/Manage/{0}", reservation.ID)'>
                                                @ConvertIntTo24Hour(reservation.TimeSlot)
                                            </a>
                                        }
                                    </span>
                                }
                                else
                                {
                                    <span class="btn btn-default disabled">
                                        None
                                    </span>
                                }
                            }
                        </td>

                            counter++;

                            if (counter % numPerRow == 1)
                            {
                                @:</tr>
                            }
                    }
                    </tr>

                </table>

            <!-- List reservation times (for everyone but the owner, since the owner already knows) -->
            @if (!IsOwner())
            {
                <div class="col-xs-6">
                    <h4>
                        Reservations
                    </h4>

                    <select>
                        <option value="-1">--- See All Available Times ---</option>
                        @for (var i = restaurant.OpeningHourStart; i < restaurant.OpeningHourEnd; i++)
                        {
                            <option value="@i.ToString()">@ConvertIntTo24Hour(i)</option>
                        }
                    </select>
                </div>
            }
        </div>

        <!-- Manage Priority Queue -->
        <div class="col-md-6">
            <h3>
                Priority Queue
                <span class="label label-default">
                    @allCustomers.Count()
                </span>
                &nbsp;
                @if (IsOwner())
                {
                    <a class="btn btn-info" href='@string.Format("/Customers/Create/{0}", restaurant.ID)'>
                        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                    </a>
                }
            </h3>
            <hr />
            <div class="col-md-6">
                <table class="table table-striped table-hover ">
                    <!-- contents -->
                    @{
                        counter = 1;
                    }
                    @foreach (var item in allCustomers)
                    {
                        <tr>
                            <td>
                                <span class="label label-default">#@counter</span>
                                @if (IsOwner())
                                {
                                    <a class="btn btn-default" href='@string.Format("/Customers/AssignTable/{0}", item.ID)'>
                                        @item.GroupCapacity<span class="glyphicon glyphicon-user"></span> &emsp; @item.Name
                                    </a>
                                }
                                else
                                {
                                    <a class="btn btn-default disabled">
                                        @item.GroupCapacity<span class="glyphicon glyphicon-user"></span> &emsp; @item.Name
                                    </a>
                                }
                            </td>
                        </tr>
                        counter++;
                    }
                </table>

            </div>
        </div>

        <!-- Display news -->
        <div class="col-xs-3">
            <h4>
                News
                &nbsp;
                <!-- Only the restaurant can add news-->
                @if (IsOwner())
                {
                    <a class="btn btn-info" href='@string.Format("/NewsInfos/Create/{0}", restaurant.ID)'>
                        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                    </a>
                }
            </h4>
            <hr />
            <!-- Check if there's any news for today-->
            @if (mostRecentNews == null)
            {
                <span>No News</span>

                <br />
            }
            else
            {
                @mostRecentNews.Content <br />
                <i>Posted On @mostRecentNews.Date</i>

                <br />

                <a class="btn btn-info" href='@string.Format("/Restaurants/ViewNews/{0}", restaurant.ID)'>
                    &laquo; View All &raquo;
                </a>
            }
        </div>
    </div>


</div>